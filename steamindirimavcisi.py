# -*- coding: utf-8 -*-
"""SteamindirimAvcisi.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1pyEhI6LIH7xH56hugC4yGdDuhI2S8W5z
"""

import requests
from bs4 import BeautifulSoup
import time
from datetime import datetime

# --- AYARLAR ---
TELEGRAM_TOKEN = "Buraya Token gelecek"
CHAT_ID = "Buraya hangi kiÅŸiye yada gruba botu Ã§alÄ±ÅŸtÄ±racaksanÄ±z onun ID si gelecek" # Ã–rn: "-10012345678" (TÄ±rnak iÃ§inde)

# --- HAFIZA ---
# Botun oyunlarÄ± hatÄ±rlamasÄ± iÃ§in boÅŸ bir sÃ¶zlÃ¼k
# Format: { 'APP_ID': Ä°ndirim_OranÄ± } -> { '2195250': 50 }
hafiza = {}

def telegrama_gonder(mesaj):
    try:
        url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
        payload = {"chat_id": CHAT_ID, "text": mesaj, "parse_mode": "HTML"}
        requests.post(url, json=payload)
    except:
        pass # Hata olursa bot durmasÄ±n

def botu_calistir():
    print(f"ğŸ¤– Bot BaÅŸlatÄ±ldÄ±! {datetime.now().strftime('%H:%M:%S')}")
    print("Mevcut indirimleri hafÄ±zaya alÄ±yor, sadece deÄŸiÅŸiklikleri bildirecek...\n")

    while True: # SONSUZ DÃ–NGÃœ
        try:
            # 1. Steam Top Listesini Ã‡ek
            url = "https://store.steampowered.com/search/?filter=topsellers&cc=tr&l=turkish"
            headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'}
            cookies = {'birthtime': '568028401', 'lastagecheckage': '1-0-1990', 'wants_mature_content': '1'}

            response = requests.get(url, headers=headers, cookies=cookies)
            soup = BeautifulSoup(response.content, 'html.parser')
            oyunlar = soup.select('#search_resultsRows > a')[:40] # Ä°lk 40 oyuna bak

            # Bu turda gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z oyunlarÄ± not alalÄ±m
            bu_tur_gorulenler = []

            for oyun in oyunlar:
                app_id = oyun.get('data-ds-appid')
                if not app_id or ',' in app_id: continue

                # API KontrolÃ¼
                api_url = f"https://store.steampowered.com/api/appdetails?appids={app_id}&cc=tr&filters=price_overview,basic"
                try:
                    res = requests.get(api_url).json()
                except:
                    continue # API hatasÄ± varsa geÃ§

                if res and str(app_id) in res and res[str(app_id)]["success"]:
                    data = res[str(app_id)]["data"]

                    if data.get("is_free") == True: continue
                    if not data.get("price_overview"): continue

                    isim = data["name"]
                    fiyat_data = data["price_overview"]
                    yeni_indirim = fiyat_data['discount_percent']

                    # Bu oyunu gÃ¶rdÃ¼ÄŸÃ¼mÃ¼zÃ¼ not et
                    bu_tur_gorulenler.append(app_id)

                    # --- HAFIZA KONTROLÃœ (EN Ã–NEMLÄ° KISIM) ---
                    eski_indirim = hafiza.get(app_id, 0) # HafÄ±zada yoksa 0 kabul et

                    # SENARYO 1: YENÄ° Ä°NDÄ°RÄ°M BAÅLADI (Eskiden 0'dÄ±, ÅŸimdi > 0)
                    if eski_indirim == 0 and yeni_indirim > 0:
                        final = fiyat_data['final'] / 100
                        ilk = fiyat_data['initial'] / 100
                        kazanc = ilk - final

                        mesaj = (
                            f"ğŸš¨ <b>YENÄ° Ä°NDÄ°RÄ°M BAÅLADI!</b>\n\n"
                            f"ğŸ® <b>{isim}</b>\n"
                            f"ğŸ”¥ Ä°ndirim: <b>%{yeni_indirim}</b>\n"
                            f"ğŸ’° Fiyat: {final} {fiyat_data['currency']}\n"
                            f"ğŸ“‰ Eski: {ilk}\n"
                            f"ğŸ”— <a href='https://store.steampowered.com/app/{app_id}'>Ä°ncele</a>"
                        )
                        telegrama_gonder(mesaj)
                        print(f"ğŸ”” Yeni Ä°ndirim Bildirildi: {isim}")

                    # SENARYO 2: Ä°NDÄ°RÄ°M ORANI ARTTI (Eskiden %20, ÅŸimdi %50)
                    elif yeni_indirim > eski_indirim:
                        mesaj = (
                            f"ğŸ”¥ <b>Ä°NDÄ°RÄ°M YÃœKSELDÄ°!</b>\n"
                            f"ğŸ® {isim}: %{eski_indirim} -> <b>%{yeni_indirim}</b> oldu!"
                        )
                        telegrama_gonder(mesaj)

                    # SENARYO 3: Ä°NDÄ°RÄ°M BÄ°TTÄ° (Eskiden indirimdeydi, ÅŸimdi 0)
                    # Bunu dÃ¶ngÃ¼ dÄ±ÅŸÄ±nda kontrol edeceÄŸiz ama burada notunu gÃ¼ncelleyelim.

                    # HafÄ±zayÄ± GÃ¼ncelle
                    hafiza[app_id] = yeni_indirim

                # API ban yememek iÃ§in minik bekleme
                time.sleep(0.5)

            # --- Ä°NDÄ°RÄ°MÄ° BÄ°TENLERÄ° KONTROL ET ---
            # HafÄ±zada olup, bu turda artÄ±k indirimde olmayanlarÄ± bulabiliriz
            # (Basitlik olsun diye ÅŸimdilik sadece yeni indirimleri ekledim,
            # indirim bitti mesajÄ± bazen can sÄ±kÄ±cÄ± olabilir, istersen ekleriz)

            print(f"âœ… Kontrol tamamlandÄ±. 60 saniye bekleniyor... ({datetime.now().strftime('%H:%M')})")
            time.sleep(60) # 1 Dakika uyu

        except Exception as e:
            print(f"âš ï¸ Bir hata oldu, 10 saniye sonra tekrar denenecek: {e}")
            time.sleep(10)

if __name__ == "__main__":
    botu_calistir()